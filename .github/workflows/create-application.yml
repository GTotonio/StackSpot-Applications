name: Run - Criar Aplica√ß√£o

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Nome do novo projeto'
        required: true
      project_type:
        description: 'Tipo de aplica√ß√£o'
        required: true
        type: choice
        options:
          - Backend - Python
          - Frontend - Angular Shell
          - Frontend - Angular MFE

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - name: Definir vari√°veis
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            WORKFLOW_VERSION=${GITHUB_REF#refs/tags/}
          else
            echo "‚ùå - A cria√ß√£o da aplica√ß√£o s√≥ pode ser inciada √† partir de uma tag."
            exit 1
          fi
          INPUT_PROJECT_NAME="${{ github.event.inputs.project_name }}"
          INPUT_PROJECT_TYPE="${{ github.event.inputs.project_type }}"

          echo "‚ÑπÔ∏è - Vers√£o do workflow: $WORKFLOW_VERSION"
          echo "‚ÑπÔ∏è - Nome do reposit√≥rio: $INPUT_PROJECT_NAME"
          echo "‚ÑπÔ∏è - Tipo do reposit√≥rio: $INPUT_PROJECT_TYPE"
          
          PROJECT_TYPE="frontend"
          if [[ $INPUT_PROJECT_TYPE == *Python ]]; then
            PROJECT_TEMPLATE="StackSpot-Application-Python"
            PROJECT_TYPE="backend"
          elif [[ $INPUT_PROJECT_TYPE == *Angular\ Shell ]]; then
            PROJECT_TEMPLATE="StackSpot-Application-Angular-Shell"
          elif [[ $INPUT_PROJECT_TYPE == *Angular\ MFE ]]; then
            PROJECT_TEMPLATE="StackSpot-Application-Angular-MFE"
          else
            echo "‚ùå - O tipo do reposit√≥rio selecionado √© inv√°lido."
            exit 1
          fi

          echo "WORKFLOW_VERSION=$WORKFLOW_VERSION" >> $GITHUB_ENV
          echo "INPUT_PROJECT_NAME=$INPUT_PROJECT_NAME" >> $GITHUB_ENV
          echo "INPUT_PROJECT_TYPE=$INPUT_PROJECT_TYPE" >> $GITHUB_ENV
          echo "PROJECT_TEMPLATE=$PROJECT_TEMPLATE" >> $GITHUB_ENV
          echo "PROJECT_TYPE=$PROJECT_TYPE" >> $GITHUB_ENV
          echo "PROJECT_NAME=gen-$WORKFLOW_VERSION-$PROJECT_TYPE-$INPUT_PROJECT_NAME" >> $GITHUB_ENV

      - name: Criar reposit√≥rio via API
        run: |

          echo "üëç - Nome do reposit√≥rio gerado: $PROJECT_NAME"

          curl -X POST \
            -H "Authorization: token ${{ secrets.TEMPLATE_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user/repos \
            -d "{\"name\":\"$PROJECT_NAME\", \"private\":false}"

          echo "‚úÖ - Reposit√≥rio criado com sucesso."

      - name: Clonar template correspondente
        run: |

          echo "‚è≥ - Clonando template $PROJECT_TEMPLATE para o novo reposit√≥rio $PROJECT_NAME..."

          USER=GTotonio
          
          git clone "https://$USER:${{ secrets.TEMPLATE_TOKEN }}@github.com/GTotonio/$PROJECT_TEMPLATE.git" temp

          echo "‚úÖ - Clone efetuado."
          echo "‚è≥ -Criando arquivos iniciais..."
          
          cd temp
          git remote remove origin
          git remote add origin https://$USER:${{ secrets.TEMPLATE_TOKEN }}@github.com/GTotonio/$PROJECT_NAME.git
          git push -u origin main

          echo "‚úÖ - Processo de cria√ß√£o de novo reposit√≥rio conclu√≠do. Link: https://github.com/$USER/$PROJECT_NAME.git"
