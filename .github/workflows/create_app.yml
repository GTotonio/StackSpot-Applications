name: Create Application

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Nome do novo projeto'
        required: true
      type:
        description: 'Tipo de aplicação'
        required: true
        type: choice
        options:
          - Backend - Python
          - Frontend - Angular Shell
          - Frontend - Angular MFE

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - name: Definir variáveis
        run: |
          echo "PROJECT_NAME=${{ github.event.inputs.project_name }}" >> $GITHUB_ENV
          echo "TYPE=${{ github.event.inputs.type }}" >> $GITHUB_ENV
          WORKFLOW_VERSION="v1"

      - name: Criar repositório via API
        run: |
          REPO_TYPE="frontend"
          
          if [[ "${{ env.TYPE }}" == *Python ]]; then
            TEMPLATE_REPO="StackSpot-Application-Python"
            REPO_TYPE="backend"
          elif [[ "${{ env.TYPE }}" == *Angular\ Shell ]]; then
            TEMPLATE_REPO="StackSpot-Application-Angular-Shell"
          elif [[ "${{ env.TYPE }}" == *Angular\ MFE ]]; then
            TEMPLATE_REPO="StackSpot-Application-Angular-MFE"
          else
            echo "Tipo de aplicação inválido: ${{ env.TYPE }}"
            exit 1
          fi

          REPO_NAME="gen-${WORKFLOW_VERSION}-${REPO_TYPE}-${{ env.PROJECT_NAME }}"

          curl -X POST \
            -H "Authorization: token ${{ secrets.TEMPLATE_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user/repos \
            -d "{\"name\":\"$REPO_NAME\", \"private\":false}"

      - name: Clonar template correspondente
        run: |

          echo "Clonando template: $TEMPLATE_REPO para o repositório $REPO_NAME..."
          git clone https://$TEMPLATE_TOKEN@github.com/$TEMPLATE_REPO.git temp
          
          cd temp
          git remote remove origin
          git remote add origin https://github.com/GTotonio/$REPO_NAME.git
          git push -u origin main
